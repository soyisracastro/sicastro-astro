---
import BlogLayout from '@/layouts/BlogLayout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import BlogCard from '@/components/BlogCard.astro';
import { calculateReadingTime, stripHtml } from '@/lib/utils';
import { fetchGraphQL } from '@/lib/wordpress/client';
import { GET_POSTS, GET_POST_BY_SLUG_WITH_SEO, GET_RELATED_POSTS } from '@/lib/wordpress/queries';
import type { PostsQueryResponse, PostQueryResponse } from '@/lib/wordpress/types';

// Generate static paths from WordPress posts
export async function getStaticPaths() {
  try {
    const data = await fetchGraphQL<PostsQueryResponse>(GET_POSTS, { first: 100 });
    const posts = data.posts.nodes;
    
    return posts.map(post => ({
      params: { slug: post.slug },
    }));
  } catch (error) {
    console.warn('⚠️ WordPress not available, using mock paths');
    // Fallback to mock paths
    return [
      { params: { slug: 'nuevas-disposiciones-fiscales-2025' } },
      { params: { slug: 'organizar-facturas-electronicas' } },
      { params: { slug: 'obligaciones-primer-trimestre' } },
    ];
  }
}

const { slug } = Astro.params;

// Always fetch the complete post data (including content) by slug
let post: any = null;

try {
  const data = await fetchGraphQL<PostQueryResponse>(GET_POST_BY_SLUG_WITH_SEO, { slug });
  if (data.postBy) {
    post = data.postBy;
    console.log('✅ Post completo cargado desde WordPress:', post.title, '- Content:', post.content ? 'Sí' : 'No');
  }
} catch (error) {
  console.error('⚠️ Error al obtener post de WordPress:', error);
}

// Fallback to mock post if WordPress not available
const mockPost = post || {
  id: '1',
  title: 'Nuevas Disposiciones Fiscales para 2025',
  content: `
    <p>El Servicio de Administración Tributaria (SAT) ha anunciado importantes cambios en las disposiciones fiscales que entrarán en vigor a partir del 1 de enero de 2025. Estos cambios afectarán tanto a personas físicas como morales, por lo que es fundamental estar preparados.</p>

    <h2>Principales Cambios</h2>

    <h3>1. Nuevas Obligaciones de Facturación</h3>
    <p>A partir de 2025, todos los contribuyentes deberán emitir facturas electrónicas (CFDI 4.0) con información más detallada sobre las operaciones realizadas. Esto incluye:</p>
    <ul>
      <li>Descripción más específica de productos y servicios</li>
      <li>Nuevos complementos según el tipo de operación</li>
      <li>Validación en tiempo real con el SAT</li>
    </ul>

    <h3>2. Actualización de Declaraciones</h3>
    <p>Las declaraciones mensuales y anuales tendrán nuevos formatos que incluirán información adicional sobre:</p>
    <ul>
      <li>Operaciones con partes relacionadas</li>
      <li>Comprobantes de nómina</li>
      <li>Información de pagos provisionales</li>
    </ul>

    <h3>3. Nuevos Estímulos Fiscales</h3>
    <p>El gobierno ha implementado nuevos estímulos fiscales para fomentar la inversión en ciertos sectores:</p>
    <ul>
      <li>Tecnología e innovación</li>
      <li>Energías renovables</li>
      <li>Desarrollo regional</li>
    </ul>

    <h2>¿Cómo Prepararse?</h2>
    <p>Para estar listos ante estos cambios, recomendamos:</p>
    <ol>
      <li>Actualizar tu software de facturación</li>
      <li>Revisar tus procesos internos</li>
      <li>Capacitar a tu equipo</li>
      <li>Consultar con un especialista fiscal</li>
    </ol>

    <h2>Conclusión</h2>
    <p>Los cambios fiscales son constantes en México, por lo que es fundamental contar con asesoría profesional que te ayude a cumplir con tus obligaciones de manera eficiente y oportuna.</p>

    <p>En <strong>S I Castro Consultores</strong> estamos listos para ayudarte a navegar estos cambios. Contáctanos para una consulta gratuita.</p>
  `,
  excerpt: 'Conoce los cambios más importantes en materia fiscal que entrarán en vigor el próximo año.',
  date: '2024-12-15T10:00:00',
  slug: 'nuevas-disposiciones-fiscales-2025',
  featuredImage: {
    node: {
      sourceUrl: '/images/blog/fiscal-2025.jpg',
      altText: 'Nuevas disposiciones fiscales 2025',
    },
  },
  categories: {
    nodes: [{ name: 'Noticias Fiscales', slug: 'noticias-fiscales' }],
  },
  author: {
    node: {
      name: 'C.P. Salvador Castro',
      avatar: { url: '/images/team/salvador-castro.jpg' },
    },
  },
};

const currentPost = post || mockPost;
const readingTime = calculateReadingTime(stripHtml(currentPost.content));

const seo = {
  title: currentPost.seo?.title || `${currentPost.title} | Blog S I Castro Consultores`,
  description: currentPost.seo?.metaDesc || currentPost.excerpt,
  url: `https://sicastro.com/blog/${currentPost.slug}`,
  type: 'article' as const,
  publishedTime: currentPost.date,
  author: currentPost.author.node.name,
  image: currentPost.seo?.opengraphImage?.sourceUrl || currentPost.featuredImage?.node.sourceUrl,
};

// Get related posts if WordPress is available
let relatedPosts: any[] = [];
const isWordPressConnected = !!post;

if (isWordPressConnected && currentPost.categories.nodes[0]) {
  try {
    const categorySlug = currentPost.categories.nodes[0].slug;
    const relatedData = await fetchGraphQL<any>(GET_RELATED_POSTS, {
      categorySlug,
      excludeId: currentPost.id,
      first: 2,
    });
    relatedPosts = relatedData.posts.nodes;
  } catch (error) {
    console.warn('Could not fetch related posts:', error);
  }
}

// Fallback related posts
if (relatedPosts.length === 0) {
  relatedPosts = [
    {
      title: 'Cómo optimizar tu carga fiscal',
      slug: 'optimizar-carga-fiscal',
      excerpt: 'Estrategias legales para reducir impuestos.',
      date: '2024-12-01',
      featuredImage: { node: { sourceUrl: '/images/blog/fiscal.jpg' } },
    },
    {
      title: 'Calendario fiscal 2025',
      slug: 'calendario-fiscal-2025',
      excerpt: 'Todas las fechas importantes del año.',
      date: '2024-11-28',
      featuredImage: { node: { sourceUrl: '/images/blog/calendar.jpg' } },
    },
  ];
}
---

<BlogLayout
  seo={seo}
  title={currentPost.title}
  date={currentPost.date}
  author={currentPost.author.node.name}
  category={currentPost.categories.nodes[0]?.name}
  image={currentPost.featuredImage?.node.sourceUrl}
  readingTime={readingTime}
>
  {!isWordPressConnected && (
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8">
      <p class="text-sm text-yellow-800">
        <strong>Modo Desarrollo:</strong> Este es contenido de ejemplo. Configura WordPress para ver posts reales.
      </p>
    </div>
  )}

  <div set:html={currentPost.content} />

  <div slot="related-posts">
    <Section background="background" padding="md">
      <Container size="md">
        <h2 class="font-heading text-3xl font-bold text-dark mb-8 text-center">
          Artículos Relacionados
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {relatedPosts.map(relatedPost => (
            <BlogCard
              title={relatedPost.title}
              excerpt={relatedPost.excerpt}
              date={relatedPost.date}
              slug={relatedPost.slug}
              image={relatedPost.featuredImage?.node.sourceUrl || relatedPost.image}
            />
          ))}
        </div>
      </Container>
    </Section>
  </div>
</BlogLayout>