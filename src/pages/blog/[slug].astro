---
import BlogLayout from '@/layouts/BlogLayout.astro';
import Container from '@/components/ui/Container.astro';
import Section from '@/components/ui/Section.astro';
import BlogCard from '@/components/BlogCard.astro';
import Button from '@/components/ui/Button.astro';
import { calculateReadingTime, stripHtml } from '@/lib/utils';
import { fetchGraphQL } from '@/lib/wordpress/client';
import { GET_POSTS, GET_POST_BY_SLUG_WITH_SEO, GET_RELATED_POSTS } from '@/lib/wordpress/queries';
import type { PostsQueryResponse, PostQueryResponse, WordPressPost } from '@/lib/wordpress/types';

// Generate static paths from WordPress posts
export async function getStaticPaths() {
  try {
    const data = await fetchGraphQL<PostsQueryResponse>(GET_POSTS, { first: 100 });
    const posts = data.posts.nodes;
    
    return posts.map(post => ({
      params: { slug: post.slug },
    }));
  } catch (error) {
    console.warn('⚠️ WordPress not available, using mock paths');
    // Fallback to mock paths
    return [
      { params: { slug: 'nuevas-disposiciones-fiscales-2025' } },
      { params: { slug: 'organizar-facturas-electronicas' } },
      { params: { slug: 'obligaciones-primer-trimestre' } },
    ];
  }
}

const { slug } = Astro.params;

// Always fetch the complete post data (including content) by slug
let post: WordPressPost | null = null;

try {
  const data = await fetchGraphQL<PostQueryResponse>(GET_POST_BY_SLUG_WITH_SEO, { slug });
  if (data.postBy) {
    post = data.postBy;
    console.log('✅ Post completo cargado desde WordPress:', post.title, '- Content:', post.content ? 'Sí' : 'No');
  }
} catch (error) {
  console.error('⚠️ Error al obtener post de WordPress:', error);
}

// Fallback to mock post if WordPress not available
const mockPost = post || {
  id: '1',
  title: 'Nuevas Disposiciones Fiscales para 2025',
  content: `
    <p>El Servicio de Administración Tributaria (SAT) ha anunciado importantes cambios en las disposiciones fiscales que entrarán en vigor a partir del 1 de enero de 2025. Estos cambios afectarán tanto a personas físicas como morales, por lo que es fundamental estar preparados.</p>

    <h2>Principales Cambios</h2>

    <h3>1. Nuevas Obligaciones de Facturación</h3>
    <p>A partir de 2025, todos los contribuyentes deberán emitir facturas electrónicas (CFDI 4.0) con información más detallada sobre las operaciones realizadas. Esto incluye:</p>
    <ul>
      <li>Descripción más específica de productos y servicios</li>
      <li>Nuevos complementos según el tipo de operación</li>
      <li>Validación en tiempo real con el SAT</li>
    </ul>

    <h3>2. Actualización de Declaraciones</h3>
    <p>Las declaraciones mensuales y anuales tendrán nuevos formatos que incluirán información adicional sobre:</p>
    <ul>
      <li>Operaciones con partes relacionadas</li>
      <li>Comprobantes de nómina</li>
      <li>Información de pagos provisionales</li>
    </ul>

    <h3>3. Nuevos Estímulos Fiscales</h3>
    <p>El gobierno ha implementado nuevos estímulos fiscales para fomentar la inversión en ciertos sectores:</p>
    <ul>
      <li>Tecnología e innovación</li>
      <li>Energías renovables</li>
      <li>Desarrollo regional</li>
    </ul>

    <h2>¿Cómo Prepararse?</h2>
    <p>Para estar listos ante estos cambios, recomendamos:</p>
    <ol>
      <li>Actualizar tu software de facturación</li>
      <li>Revisar tus procesos internos</li>
      <li>Capacitar a tu equipo</li>
      <li>Consultar con un especialista fiscal</li>
    </ol>

    <h2>Conclusión</h2>
    <p>Los cambios fiscales son constantes en México, por lo que es fundamental contar con asesoría profesional que te ayude a cumplir con tus obligaciones de manera eficiente y oportuna.</p>

    <p>En <strong>S I Castro Consultores</strong> estamos listos para ayudarte a navegar estos cambios. Contáctanos para una consulta gratuita.</p>
  `,
  excerpt: 'Conoce los cambios más importantes en materia fiscal que entrarán en vigor el próximo año.',
  date: '2024-12-15T10:00:00',
  slug: 'nuevas-disposiciones-fiscales-2025',
  featuredImage: {
    node: {
      sourceUrl: '/images/blog/fiscal-2025.jpg',
      altText: 'Nuevas disposiciones fiscales 2025',
    },
  },
  categories: {
    nodes: [{ id: '1', name: 'Noticias Fiscales', slug: 'noticias-fiscales' }],
  },
  author: {
    node: {
      name: 'C.P. Salvador Castro',
      avatar: { url: '/images/team/salvador-castro.jpg' },
    },
  },
};

const currentPost = post || mockPost;
const readingTime = calculateReadingTime(stripHtml(currentPost.content));

const seo = {
  title: currentPost.seo?.title || `${currentPost.title} | Blog S I Castro Consultores`,
  description: currentPost.seo?.metaDesc || currentPost.excerpt,
  url: `https://sicastro.com/blog/${currentPost.slug}`,
  type: 'article' as const,
  publishedTime: currentPost.date,
  author: currentPost.author.node.name,
  image: currentPost.seo?.opengraphImage?.sourceUrl || currentPost.featuredImage?.node.sourceUrl,
};

// Get related posts if WordPress is available
let relatedPosts: WordPressPost[] = [];
const isWordPressConnected = !!post;

if (isWordPressConnected && currentPost.categories.nodes[0]) {
  try {
    const categorySlug = currentPost.categories.nodes[0].slug;
    const relatedData = await fetchGraphQL<PostsQueryResponse>(GET_RELATED_POSTS, {
      categorySlug,
      excludeId: currentPost.id,
      first: 2,
    });
    relatedPosts = relatedData.posts.nodes;
  } catch (error) {
    console.warn('Could not fetch related posts:', error);
  }
}

// Fallback related posts
if (relatedPosts.length === 0) {
  relatedPosts = [
    {
      id: '1',
      title: 'Cómo optimizar tu carga fiscal',
      slug: 'optimizar-carga-fiscal',
      excerpt: 'Estrategias legales para reducir impuestos.',
      content: '',
      date: '2024-12-01',
      featuredImage: { node: { sourceUrl: '/images/blog/fiscal.jpg', altText: 'Optimizar carga fiscal' } },
      categories: { nodes: [{ id: '1', name: 'Fiscal', slug: 'fiscal' }] },
      author: { node: { name: 'C.P. Salvador Castro', avatar: { url: '' } } },
    },
    {
      id: '2',
      title: 'Calendario fiscal 2025',
      slug: 'calendario-fiscal-2025',
      excerpt: 'Todas las fechas importantes del año.',
      content: '',
      date: '2024-11-28',
      featuredImage: { node: { sourceUrl: '/images/blog/calendar.jpg', altText: 'Calendario fiscal' } },
      categories: { nodes: [{ id: '1', name: 'Fiscal', slug: 'fiscal' }] },
      author: { node: { name: 'C.P. Salvador Castro', avatar: { url: '' } } },
    },
  ];
}
---

<BlogLayout
  seo={seo}
  title={currentPost.title}
  date={currentPost.date}
  author={currentPost.author.node.name}
  category={currentPost.categories.nodes[0]?.name}
  image={currentPost.featuredImage?.node.sourceUrl}
  readingTime={readingTime}
>
  {!isWordPressConnected && (
    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4 mb-8">
      <p class="text-sm text-yellow-800">
        <strong>Modo Desarrollo:</strong> Este es contenido de ejemplo. Configura WordPress para ver posts reales.
      </p>
    </div>
  )}

  <div set:html={currentPost.content} />

  <!-- CTA -->
  <div class="my-16 -mx-8 md:-mx-12 not-prose">
    <div class="bg-text-primary text-white px-8 md:px-12 py-12 md:py-16">
      <div class="max-w-2xl mx-auto text-center">
        <!-- Hook - El Problema -->
        <p class="text-lg md:text-xl text-white/90 mb-4 leading-relaxed">
          ¿Cada cambio fiscal te genera más dudas que certezas?
        </p>
        
        <!-- Headline - La Oferta -->
        <h2 class="text-3xl md:text-4xl text-white/90 font-bold mb-6 leading-tight">
          Deja de Perder Tiempo (y Dinero) Intentando Entenderlo Solo
        </h2>
        
        <!-- Beneficio Claro -->
        <p class="text-lg text-white/90 mb-8 leading-relaxed">
          Nuestro equipo de contadores certificados se encarga de todo tu cumplimiento fiscal mientras tú te enfocas en hacer crecer tu negocio. <strong class="text-white">Sin sorpresas, sin multas, sin estrés.</strong>
        </p>
        
        <!-- Social Proof Rápido -->
        <div class="flex items-center justify-center gap-8 mb-8 text-white/80 text-sm">
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
            </svg>
            <span>+500 empresas</span>
          </div>
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>15+ años</span>
          </div>
          <div class="flex items-center">
            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span>100% confiable</span>
          </div>
        </div>
        
        <!-- CTA Principal -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <Button 
            href="/contacto" 
            variant="secondary" 
            size="lg"
            class="bg-white text-text-primary hover:bg-white/90 border-0 font-semibold text-lg px-8 py-4"
          >
            Solicitar Consulta Gratuita
          </Button>
          <Button 
            href="/servicios" 
            variant="ghost"
            size="lg"
            class="text-white border border-white/30 hover:bg-white/10 font-medium text-lg px-8 py-4"
          >
            Ver Servicios
          </Button>
        </div>
        
        <!-- Garantía/Risk Reversal -->
        <p class="text-sm text-white/70 mt-6">
          Primera consulta gratuita · Sin compromiso · Respuesta en menos de 24 horas
        </p>
      </div>
    </div>
  </div>

  <div slot="related-posts" class="rounded-lg overflow-hidden not-prose">
    <Section background="background" padding="md">
      <Container>
        <h2 class="text-3xl font-bold text-text-primary mb-10 text-center">
          Artículos Relacionados
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          {relatedPosts.map(relatedPost => (
            <BlogCard
              title={relatedPost.title}
              excerpt={relatedPost.excerpt.replace(/<[^>]*>/g, '').trim()}
              date={relatedPost.date}
              slug={relatedPost.slug}
              image={relatedPost.featuredImage?.node.sourceUrl}
            />
          ))}
        </div>
      </Container>
    </Section>
  </div>
</BlogLayout>